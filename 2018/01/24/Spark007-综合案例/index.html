<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Spark007--综合案例 | DoubleHappy or Jepson</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  
  
  <meta name="description" content="1234567891011121.数据如下    a,1,3    a,2,4    b,1,1根据第一列统计出    a,3,7    b,1,1用RDD实现分析：1）使用逗号对数据进行拆分 (a,&amp;lt;1,3&amp;gt;)  a=_.1  &amp;lt;1,3&amp;gt;=_.22）reduceByKey((a,b)=&amp;gt;a+b)   =&amp;gt;  _.2._1 + _.2._2  123456789">
<meta property="og:type" content="article">
<meta property="og:title" content="Spark007--综合案例">
<meta property="og:url" content="http:&#x2F;&#x2F;yoursite.com&#x2F;2018&#x2F;01&#x2F;24&#x2F;Spark007-%E7%BB%BC%E5%90%88%E6%A1%88%E4%BE%8B&#x2F;index.html">
<meta property="og:site_name" content="DoubleHappy or Jepson">
<meta property="og:description" content="1234567891011121.数据如下    a,1,3    a,2,4    b,1,1根据第一列统计出    a,3,7    b,1,1用RDD实现分析：1）使用逗号对数据进行拆分 (a,&amp;lt;1,3&amp;gt;)  a=_.1  &amp;lt;1,3&amp;gt;=_.22）reduceByKey((a,b)=&amp;gt;a+b)   =&amp;gt;  _.2._1 + _.2._2  123456789">
<meta property="og:locale" content="en">
<meta property="og:image" content="https:&#x2F;&#x2F;img-blog.csdnimg.cn&#x2F;20191023170856895.png?x-oss-process=image&#x2F;watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9kb3VibGVoYXBweS5ibG9nLmNzZG4ubmV0,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https:&#x2F;&#x2F;img-blog.csdnimg.cn&#x2F;20191023171046603.png?x-oss-process=image&#x2F;watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9kb3VibGVoYXBweS5ibG9nLmNzZG4ubmV0,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https:&#x2F;&#x2F;img-blog.csdnimg.cn&#x2F;20191024101322660.png?x-oss-process=image&#x2F;watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9kb3VibGVoYXBweS5ibG9nLmNzZG4ubmV0,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https:&#x2F;&#x2F;img-blog.csdnimg.cn&#x2F;2019102412035911.png?x-oss-process=image&#x2F;watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9kb3VibGVoYXBweS5ibG9nLmNzZG4ubmV0,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https:&#x2F;&#x2F;img-blog.csdnimg.cn&#x2F;20191024121310993.png?x-oss-process=image&#x2F;watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9kb3VibGVoYXBweS5ibG9nLmNzZG4ubmV0,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https:&#x2F;&#x2F;img-blog.csdnimg.cn&#x2F;20191024121544286.png?x-oss-process=image&#x2F;watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9kb3VibGVoYXBweS5ibG9nLmNzZG4ubmV0,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https:&#x2F;&#x2F;img-blog.csdnimg.cn&#x2F;20191024122713780.png?x-oss-process=image&#x2F;watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9kb3VibGVoYXBweS5ibG9nLmNzZG4ubmV0,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https:&#x2F;&#x2F;img-blog.csdnimg.cn&#x2F;20191024123422488.png?x-oss-process=image&#x2F;watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9kb3VibGVoYXBweS5ibG9nLmNzZG4ubmV0,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https:&#x2F;&#x2F;img-blog.csdnimg.cn&#x2F;20191024123557180.png?x-oss-process=image&#x2F;watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9kb3VibGVoYXBweS5ibG9nLmNzZG4ubmV0,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https:&#x2F;&#x2F;img-blog.csdnimg.cn&#x2F;2019102412383967.png?x-oss-process=image&#x2F;watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9kb3VibGVoYXBweS5ibG9nLmNzZG4ubmV0,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https:&#x2F;&#x2F;img-blog.csdnimg.cn&#x2F;2019102412411829.png?x-oss-process=image&#x2F;watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9kb3VibGVoYXBweS5ibG9nLmNzZG4ubmV0,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https:&#x2F;&#x2F;img-blog.csdnimg.cn&#x2F;20191024124752801.png?x-oss-process=image&#x2F;watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9kb3VibGVoYXBweS5ibG9nLmNzZG4ubmV0,size_16,color_FFFFFF,t_70">
<meta property="og:updated_time" content="2019-11-17T12:03:37.632Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https:&#x2F;&#x2F;img-blog.csdnimg.cn&#x2F;20191023170856895.png?x-oss-process=image&#x2F;watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9kb3VibGVoYXBweS5ibG9nLmNzZG4ubmV0,size_16,color_FFFFFF,t_70">
  
    <link rel="alternate" href="/atom.xml" title="DoubleHappy or Jepson" type="application/atom+xml">
  
  
    <link rel="icon" href="/images/default-avatar.jpg">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/highlight.css">
</head>

<body>
  <div id="fullpage" class="mobile-nav-right">
    
      <div id="wrapper" title="图片来自网络">
    
    
      <header id="header">
  <div id="nav-toggle" class="nav-toggle"></div>
  <div class="head-box global-width">
    <nav class="nav-box nav-right">
      
        <a class="nav-item" href="/archives" title
        
        >首页</a>
      
        <a class="nav-item" href="/archives" title
        
        >归档</a>
      
    </nav>
  </div>
</header>
      <div id="middlecontent" title class="global-width sidebar-right">
        <section id="main"><article id="post-Spark007-综合案例" class="article global-container article-type-post" itemscope itemprop="blogPost">
  
    <header class="article-header">
      
  
    <h1 class="article-title" itemprop="name">
      Spark007--综合案例
    </h1>
  

    </header>
  
  <div class="article-meta">
    <a href="/2018/01/24/Spark007-%E7%BB%BC%E5%90%88%E6%A1%88%E4%BE%8B/" class="article-date">
  <time datetime="2018-01-24T12:03:00.000Z" itemprop="datePublished">2018-01-24</time>
</a>
    
    
  </div>
  
    <span id="busuanzi_container_page_pv">
      本文总阅读量<span id="busuanzi_value_page_pv"></span>次
    </span>
  

  <div class="article-inner">
    
    <div class="article-content article-content-cloud" itemprop="articleBody">
      
        <div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">1.数据如下</span><br><span class="line">    a,1,3</span><br><span class="line">    a,2,4</span><br><span class="line">    b,1,1</span><br><span class="line">根据第一列统计出</span><br><span class="line">    a,3,7</span><br><span class="line">    b,1,1</span><br><span class="line">用RDD实现</span><br><span class="line"></span><br><span class="line">分析：</span><br><span class="line">1）使用逗号对数据进行拆分 (a,&lt;1,3&gt;)  a=_.1  &lt;1,3&gt;=_.2</span><br><span class="line">2）reduceByKey((a,b)=&gt;a+b)   =&gt;  _.2._1 + _.2._2</span><br></pre></td></tr></table></figure></div>

<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">package com.ruozedata.spark.spark04</span><br><span class="line">import com.ruozedata.spark.homework.utils.ContextUtils</span><br><span class="line">import com.ruozedata.spark.homework.utils.ImplicitAspect._</span><br><span class="line">object InterviewApp01 &#123;</span><br><span class="line">  def main(args: Array[String]): Unit = &#123;</span><br><span class="line">    val sc = ContextUtils.getSparkContext(this.getClass.getSimpleName)</span><br><span class="line">    val input = sc.parallelize(List(</span><br><span class="line">      List(&quot;a&quot;,1,3),</span><br><span class="line">      List(&quot;a&quot;,2,4),</span><br><span class="line">      List(&quot;b&quot;,1,1)</span><br><span class="line">    ))</span><br><span class="line">    input.map(x =&gt; &#123;</span><br><span class="line">      val key = x(0).toString</span><br><span class="line">      val v1 = x(1).toString.toInt</span><br><span class="line">      val v2 = x(2).toString.toInt</span><br><span class="line">      (key, (v1,v2))</span><br><span class="line">    &#125;).reduceByKey((x,y)=&gt;&#123;</span><br><span class="line">      (x._1 + y._1, x._2+y._2)</span><br><span class="line">    &#125;).map(x=&gt;List(x._1, x._2._1,x._2._2)).printInfo()</span><br><span class="line">    sc.stop()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">结果是：</span><br><span class="line">List(a, 3, 7)</span><br><span class="line">List(b, 1, 1)</span><br><span class="line">-------------------------</span><br></pre></td></tr></table></figure></div>

<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">2.广告投放 收费标准：</span><br><span class="line">	看到就收费</span><br><span class="line">	点击 才收费</span><br><span class="line">eg：</span><br><span class="line">&quot;1000000,一起看|电视剧|军旅|士兵突击,1,0&quot;    </span><br><span class="line"> uid,导航,1,0       （1表示看到了 0表示没有点进去）</span><br><span class="line"></span><br><span class="line">需求1：人和“一个东西”的展示量以及点击量</span><br><span class="line">eg：1000000 一起看 2 1</span><br></pre></td></tr></table></figure></div>

<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">使用reduceBykey和groupBykey都实现一下：</span><br><span class="line"></span><br><span class="line">package com.ruozedata.spark.spark04</span><br><span class="line"></span><br><span class="line">import com.ruozedata.spark.homework.utils.ContextUtils</span><br><span class="line">import com.ruozedata.spark.homework.utils.ImplicitAspect._</span><br><span class="line">object InterviewApp02 &#123;</span><br><span class="line">    def main(args: Array[String]): Unit = &#123;</span><br><span class="line">      val sc = ContextUtils.getSparkContext(this.getClass.getSimpleName)</span><br><span class="line">      val input = sc.parallelize(List(</span><br><span class="line">        &quot;1000000,一起看|电视剧|军旅|士兵突击,1,0&quot;, // uid,导航,1,0 1表示看到了 0表示没有点进去</span><br><span class="line">        &quot;1000000,一起看|电视剧|军旅|士兵突击,1,1&quot;,</span><br><span class="line">        &quot;1000001,一起看|电视剧|军旅|我的团长我的团,1,1&quot;,</span><br><span class="line">        &quot;1000000,一起看|电视剧|军旅|士兵突击,1,0&quot;, // uid,导航,</span><br><span class="line">        &quot;1000000,一起看|电视剧|军旅|士兵突击,1,1&quot;,</span><br><span class="line">        &quot;1000001,一起看|电视剧|军旅|我的团长我的团,1,1&quot;,</span><br><span class="line">        &quot;1000000,一起看|电视剧|军旅|士兵突击,1,0&quot;, // uid,导航,</span><br><span class="line">        &quot;1000000,一起看|电视剧|军旅|士兵突击,1,1&quot;,</span><br><span class="line">        &quot;1000001,一起看|电视剧|军旅|我的团长我的团,1,1&quot;,</span><br><span class="line">        &quot;1000000,一起看|电视剧|军旅|士兵突击,1,0&quot;, // uid,导航,</span><br><span class="line">        &quot;1000000,一起看|电视剧|军旅|士兵突击,1,1&quot;,</span><br><span class="line">        &quot;1000001,一起看|电视剧|军旅|我的团长我的团,1,1&quot;,</span><br><span class="line">        &quot;1000000,一起看|电视剧|军旅|士兵突击,1,0&quot;, // uid,导航,</span><br><span class="line">        &quot;1000000,一起看|电视剧|军旅|士兵突击,1,1&quot;,</span><br><span class="line">        &quot;1000001,一起看|电视剧|军旅|我的团长我的团,1,1&quot;</span><br><span class="line">      ))</span><br><span class="line"></span><br><span class="line">      /**</span><br><span class="line">        * 需求：人和“一个东西”的展示量以及点击量</span><br><span class="line">        * 1）组合key：人和所谓的一个东西</span><br><span class="line">        *</span><br><span class="line">        * 1000000 一起看 2 1</span><br><span class="line">        */</span><br><span class="line">      val processRDD = input.flatMap(x =&gt; &#123;</span><br><span class="line">        val splits = x.split(&quot;,&quot;)</span><br><span class="line">        val id = splits(0).toInt</span><br><span class="line">        val word = splits(1)</span><br><span class="line">        val show = splits(2).toInt</span><br><span class="line">        val clicks = splits(3).toInt</span><br><span class="line"></span><br><span class="line">        val words = word.split(&quot;\\|&quot;)</span><br><span class="line">        words.map(x =&gt; ((id, x), (show, clicks)))</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      /**</span><br><span class="line">        * 在每个task/partition按照key先进行一个本地的聚合mapSideCombine: Boolean = true</span><br><span class="line">        * 预聚合之后，在每个task之上对于相同key的数据只有一条</span><br><span class="line">        *</span><br><span class="line">        *</span><br><span class="line">        * 调优 前 vs 后</span><br><span class="line">        * 是否能按照调优之前和调优之后作业的执行时间来对比?</span><br><span class="line">        * 时间之外还有其他的：读进来多少数据，shuffle出去多少数据，shuffle读写花费多少时间</span><br><span class="line">        * </span><br><span class="line">        * 所以优先选择reduceByKey </span><br><span class="line">        * 	1.shuffle数据少</span><br><span class="line">        * 去4040页面查看就知道了</span><br><span class="line">        */</span><br><span class="line">      processRDD.reduceByKey((x,y)=&gt;(x._1+y._1, x._2+y._2)).printInfo()</span><br><span class="line"></span><br><span class="line">      // 数据全部进行shuffle操作</span><br><span class="line">      processRDD</span><br><span class="line">        .groupByKey().mapValues(x=&gt;&#123;</span><br><span class="line">        val totalShows = x.map(_._1).sum</span><br><span class="line">        val totalClicks = x.map(_._2).sum</span><br><span class="line">        (totalShows, totalClicks)</span><br><span class="line">      &#125;).printInfo()</span><br><span class="line"></span><br><span class="line">      sc.stop()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">结果是：</span><br><span class="line">((1000000,军旅),(10,5))</span><br><span class="line">((1000000,一起看),(10,5))</span><br><span class="line">((1000000,士兵突击),(10,5))</span><br><span class="line">((1000001,电视剧),(5,5))</span><br><span class="line">((1000001,我的团长我的团),(5,5))</span><br><span class="line">((1000001,一起看),(5,5))</span><br><span class="line">((1000001,军旅),(5,5))</span><br><span class="line">((1000000,电视剧),(10,5))</span><br><span class="line">-------------------------</span><br><span class="line">((1000000,一起看),(10,5))</span><br><span class="line">((1000000,军旅),(10,5))</span><br><span class="line">((1000001,电视剧),(5,5))</span><br><span class="line">((1000000,士兵突击),(10,5))</span><br><span class="line">((1000001,军旅),(5,5))</span><br><span class="line">((1000001,我的团长我的团),(5,5))</span><br><span class="line">((1000001,一起看),(5,5))</span><br><span class="line">((1000000,电视剧),(10,5))</span><br><span class="line">-------------------------</span><br></pre></td></tr></table></figure></div>

<p><img src="https://img-blog.csdnimg.cn/20191023170856895.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9kb3VibGVoYXBweS5ibG9nLmNzZG4ubmV0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20191023171046603.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9kb3VibGVoYXBweS5ibG9nLmNzZG4ubmV0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br><strong>一定要注意数据结构</strong></p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">object InterviewApp02 &#123;</span><br><span class="line">    def main(args: Array[String]): Unit = &#123;</span><br><span class="line">      val sc = ContextUtils.getSparkContext(this.getClass.getSimpleName)</span><br><span class="line">      val input = sc.parallelize(List(</span><br><span class="line">        &quot;1000000,一起看|电视剧|军旅|士兵突击,1,0&quot;, // uid,导航,1,0 1表示看到了 0表示没有点进去</span><br><span class="line">        &quot;1000000,一起看|电视剧|军旅|士兵突击,1,1&quot;,</span><br><span class="line">        &quot;1000001,一起看|电视剧|军旅|我的团长我的团,1,1&quot;,</span><br><span class="line">        &quot;1000000,一起看|电视剧|军旅|士兵突击,1,0&quot;, // uid,导航,</span><br><span class="line">        &quot;1000000,一起看|电视剧|军旅|士兵突击,1,1&quot;,</span><br><span class="line">        &quot;1000001,一起看|电视剧|军旅|我的团长我的团,1,1&quot;,</span><br><span class="line">        &quot;1000000,一起看|电视剧|军旅|士兵突击,1,0&quot;, // uid,导航,</span><br><span class="line">        &quot;1000000,一起看|电视剧|军旅|士兵突击,1,1&quot;,</span><br><span class="line">        &quot;1000001,一起看|电视剧|军旅|我的团长我的团,1,1&quot;,</span><br><span class="line">        &quot;1000000,一起看|电视剧|军旅|士兵突击,1,0&quot;, // uid,导航,</span><br><span class="line">        &quot;1000000,一起看|电视剧|军旅|士兵突击,1,1&quot;,</span><br><span class="line">        &quot;1000001,一起看|电视剧|军旅|我的团长我的团,1,1&quot;,</span><br><span class="line">        &quot;1000000,一起看|电视剧|军旅|士兵突击,1,0&quot;, // uid,导航,</span><br><span class="line">        &quot;1000000,一起看|电视剧|军旅|士兵突击,1,1&quot;,</span><br><span class="line">        &quot;1000001,一起看|电视剧|军旅|我的团长我的团,1,1&quot;</span><br><span class="line">      ))</span><br><span class="line"></span><br><span class="line">      /**</span><br><span class="line">        * 需求：人和“一个东西”的展示量以及点击量</span><br><span class="line">        * 1）组合key：人和所谓的一个东西</span><br><span class="line">        *</span><br><span class="line">        * 1000000 一起看 2 1</span><br><span class="line">        * flatMap 注意 为什么不用map *** </span><br><span class="line">        */</span><br><span class="line">      val processRDD = input.flatMap(x =&gt; &#123;</span><br><span class="line">        val splits = x.split(&quot;,&quot;)</span><br><span class="line">        val id = splits(0).toInt</span><br><span class="line">        val word = splits(1)</span><br><span class="line">        val show = splits(2).toInt</span><br><span class="line">        val clicks = splits(3).toInt</span><br><span class="line"></span><br><span class="line">        val words = word.split(&quot;\\|&quot;)</span><br><span class="line">        words.map(x =&gt; ((id, x), (show, clicks)))</span><br><span class="line">      &#125;)</span><br><span class="line">      // 数据全部进行shuffle操作</span><br><span class="line">      processRDD</span><br><span class="line">        .groupByKey().printInfo()</span><br><span class="line">      sc.stop()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">结果是：</span><br><span class="line">((1000000,一起看),CompactBuffer((1,0), (1,1), (1,0), (1,1), (1,0), (1,1), (1,0), (1,1), (1,0), (1,1)))</span><br><span class="line">((1000000,军旅),CompactBuffer((1,0), (1,1), (1,0), (1,1), (1,0), (1,1), (1,0), (1,1), (1,0), (1,1)))</span><br><span class="line">((1000001,电视剧),CompactBuffer((1,1), (1,1), (1,1), (1,1), (1,1)))</span><br><span class="line">((1000000,士兵突击),CompactBuffer((1,0), (1,1), (1,0), (1,1), (1,0), (1,1), (1,0), (1,1), (1,0), (1,1)))</span><br><span class="line">((1000001,军旅),CompactBuffer((1,1), (1,1), (1,1), (1,1), (1,1)))</span><br><span class="line">((1000001,我的团长我的团),CompactBuffer((1,1), (1,1), (1,1), (1,1), (1,1)))</span><br><span class="line">((1000000,电视剧),CompactBuffer((1,0), (1,1), (1,0), (1,1), (1,0), (1,1), (1,0), (1,1), (1,0), (1,1)))</span><br><span class="line">((1000001,一起看),CompactBuffer((1,1), (1,1), (1,1), (1,1), (1,1)))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">groupByKey 没有预聚合 还记得wc那张图么 上一篇的。</span><br></pre></td></tr></table></figure></div>

<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">3.  分组排序/组内排序</span><br><span class="line">  求每个域名访问量最大的url的Top N</span><br><span class="line"></span><br><span class="line">数据格式：</span><br><span class="line">www.baidu.com,url1</span><br><span class="line">www.baidu.com,url2</span><br><span class="line">www.baidu.com,url2</span><br><span class="line">www.baidu.com,url3</span><br><span class="line">www.baidu.com,url3</span><br><span class="line">www.baidu.com,url3</span><br><span class="line">www.baidu.com,url4</span><br></pre></td></tr></table></figure></div>
<p>我们一步步来：</p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">object InterviewApp03 &#123;</span><br><span class="line"></span><br><span class="line">  def main(args: Array[String]): Unit = &#123;</span><br><span class="line"></span><br><span class="line">    val TOPN = 2</span><br><span class="line">    val sc = ContextUtils.getSparkContext(this.getClass.getSimpleName)</span><br><span class="line">    val input = sc.textFile(&quot;file:///C:/IdeaProjects/spark/data/site.log&quot;)</span><br><span class="line">    val processRDD = input.map(x =&gt; &#123;</span><br><span class="line">      val splits = x.split(&quot;,&quot;)</span><br><span class="line">      val site = splits(0)</span><br><span class="line">      val url = splits(1)</span><br><span class="line">      ((site, url), 1)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    processRDD.printInfo()</span><br><span class="line"></span><br><span class="line">    sc.stop()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">结果是：</span><br><span class="line">((www.google.com,url6),1)</span><br><span class="line">((www.baidu.com,url1),1)</span><br><span class="line">((www.baidu.com,url2),1)</span><br><span class="line">((www.google.com,url6),1)</span><br><span class="line">((www.baidu.com,url2),1)</span><br><span class="line">((www.google.com,url2),1)</span><br><span class="line">。。。。。</span><br><span class="line">-------------------------</span><br></pre></td></tr></table></figure></div>
<p>分组 ： 如何分组？ 不分组行不行？</p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">object InterviewApp03 &#123;</span><br><span class="line"></span><br><span class="line">  def main(args: Array[String]): Unit = &#123;</span><br><span class="line"></span><br><span class="line">    val TOPN = 2</span><br><span class="line">    val sc = ContextUtils.getSparkContext(this.getClass.getSimpleName)</span><br><span class="line">    val input = sc.textFile(&quot;file:///C:/IdeaProjects/spark/data/site.log&quot;)</span><br><span class="line">    val processRDD = input.map(x =&gt; &#123;</span><br><span class="line">      val splits = x.split(&quot;,&quot;)</span><br><span class="line">      val site = splits(0)</span><br><span class="line">      val url = splits(1)</span><br><span class="line">      ((site, url), 1)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">        processRDD.reduceByKey(_+_)</span><br><span class="line">          .groupBy(_._1._1)</span><br><span class="line">          .printInfo()</span><br><span class="line">    sc.stop()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">结果是：</span><br><span class="line">(www.baidu.com,CompactBuffer(</span><br><span class="line">((www.baidu.com,url1),1), </span><br><span class="line">((www.baidu.com,url3),3),</span><br><span class="line"> ((www.baidu.com,url5),5),</span><br><span class="line">  ((www.baidu.com,url2),2),</span><br><span class="line">   ((www.baidu.com,url4),4)))</span><br><span class="line">   </span><br><span class="line">(www.twitter.com,CompactBuffer(((www.twitter.com,url9),6), ((www.twitter.com,url10),11), ((www.twitter.com,url6),1)))</span><br><span class="line">(www.google.com,CompactBuffer(((www.google.com,url6),7), ((www.google.com,url8),7), ((www.google.com,url1),1), ((www.google.com,url2),2)))</span><br><span class="line">-------------------------</span><br></pre></td></tr></table></figure></div>
<p>结果：</p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">object InterviewApp03 &#123;</span><br><span class="line"></span><br><span class="line">  def main(args: Array[String]): Unit = &#123;</span><br><span class="line"></span><br><span class="line">    val TOPN = 2</span><br><span class="line">    val sc = ContextUtils.getSparkContext(this.getClass.getSimpleName)</span><br><span class="line">    val input = sc.textFile(&quot;file:///C:/IdeaProjects/spark/data/site.log&quot;)</span><br><span class="line">    val processRDD = input.map(x =&gt; &#123;</span><br><span class="line">      val splits = x.split(&quot;,&quot;)</span><br><span class="line">      val site = splits(0)</span><br><span class="line">      val url = splits(1)</span><br><span class="line">      ((site, url), 1)</span><br><span class="line">    &#125;)</span><br><span class="line">       processRDD.reduceByKey(_+_)</span><br><span class="line">          .groupBy(_._1._1)</span><br><span class="line">            .mapValues(x =&gt; &#123;</span><br><span class="line">              x.toList.sortBy(-_._2)  // toList是一个很大的安全隐患    </span><br><span class="line">                .map(x =&gt; (x._1._2, x._2)).take(TOPN)</span><br><span class="line">            &#125;).printInfo()</span><br><span class="line">    sc.stop()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">结果是：</span><br><span class="line">(www.baidu.com,List((url5,5), (url4,4)))</span><br><span class="line">(www.twitter.com,List((url10,11), (url9,6)))</span><br><span class="line">(www.google.com,List((url6,7), (url8,7)))</span><br><span class="line">-------------------------</span><br></pre></td></tr></table></figure></div>
<p>  x.toList.sortBy(-<em>.</em>2)  // toList是一个很大的安全隐患，为什么这么说呢？<br>  x来了一亿条数据 list就炸掉了 所以这样 虽然能出结果 但是不能用<br>  如何规避掉呢 这块就使用rdd算子 不用scala的高级函数</p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">如何解决呢？</span><br><span class="line">1.方法：</span><br><span class="line">	分而治之的思路</span><br><span class="line">		类似mapreduce 思想  一个文件 拆成多个inputsplits 每个split单独处理 之后reduce聚合</span><br><span class="line"></span><br><span class="line">object InterviewApp03 &#123;</span><br><span class="line">  def main(args: Array[String]): Unit = &#123;</span><br><span class="line">    val TOPN = 2</span><br><span class="line">    val sc = ContextUtils.getSparkContext(this.getClass.getSimpleName)</span><br><span class="line">    val input = sc.textFile(&quot;file:///C:/IdeaProjects/spark/data/site.log&quot;)</span><br><span class="line">    val processRDD = input.map(x =&gt; &#123;</span><br><span class="line">      val splits = x.split(&quot;,&quot;)</span><br><span class="line">      val site = splits(0)</span><br><span class="line">      val url = splits(1)</span><br><span class="line">      ((site, url), 1)</span><br><span class="line">    &#125;)</span><br><span class="line">    // 分而治之的思路</span><br><span class="line">        val sites = Array(&quot;www.baidu.com&quot;,&quot;www.google.com&quot;,&quot;www.twitter.com&quot;)</span><br><span class="line">        for(site &lt;- sites) &#123;</span><br><span class="line">          processRDD.filter(_._1._1 == site)</span><br><span class="line">            .reduceByKey(_+_).sortBy(-_._2)</span><br><span class="line">            .take(TOPN).foreach(println)</span><br><span class="line">        &#125;</span><br><span class="line">    sc.stop()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">结果是：</span><br><span class="line">((www.baidu.com,url5),5)</span><br><span class="line">((www.baidu.com,url4),4)</span><br><span class="line">((www.google.com,url6),7)</span><br><span class="line">((www.google.com,url8),7)</span><br><span class="line">((www.twitter.com,url10),11)</span><br><span class="line">((www.twitter.com,url9),6)</span><br><span class="line"></span><br><span class="line">有什么问题？</span><br><span class="line">1.会产生好多job  去ui上看 </span><br><span class="line">2.val sites = Array(&quot;www.baidu.com&quot;,&quot;www.google.com&quot;,&quot;www.twitter.com&quot;) 不要这么写</span><br></pre></td></tr></table></figure></div>

<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">方法2; 优化方法1</span><br><span class="line"></span><br><span class="line">object InterviewApp03 &#123;</span><br><span class="line"></span><br><span class="line">  def main(args: Array[String]): Unit = &#123;</span><br><span class="line"></span><br><span class="line">    val TOPN = 2</span><br><span class="line">    val sc = ContextUtils.getSparkContext(this.getClass.getSimpleName)</span><br><span class="line">    val input = sc.textFile(&quot;file:///C:/IdeaProjects/spark/data/site.log&quot;)</span><br><span class="line">    val processRDD = input.map(x =&gt; &#123;</span><br><span class="line">      val splits = x.split(&quot;,&quot;)</span><br><span class="line">      val site = splits(0)</span><br><span class="line">      val url = splits(1)</span><br><span class="line">      ((site, url), 1)</span><br><span class="line">    &#125;)</span><br><span class="line">    // 分而治之的思路</span><br><span class="line">    val sites = processRDD.map(_._1._1).distinct().collect()  // 数组</span><br><span class="line">    sites.map(x=&gt;&#123;</span><br><span class="line">      processRDD.filter(_._1._1 == x).reduceByKey(_+_).sortBy(-_._2) .take(TOPN).foreach(println)</span><br><span class="line">    &#125;)</span><br><span class="line">    sc.stop()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">结果是：</span><br><span class="line">((www.baidu.com,url5),5)</span><br><span class="line">((www.baidu.com,url4),4)</span><br><span class="line">((www.twitter.com,url10),11)</span><br><span class="line">((www.twitter.com,url9),6)</span><br><span class="line">((www.google.com,url6),7)</span><br><span class="line">((www.google.com,url8),7)</span><br><span class="line"></span><br><span class="line">问题：</span><br><span class="line"> val sites = processRDD.map(_._1._1).distinct().collect()  // 数组</span><br><span class="line">生产上能直接collect么？不能 这代码怎么改进呢？</span><br></pre></td></tr></table></figure></div>

<h2 id="Partitioner"><a href="#Partitioner" class="headerlink" title="Partitioner"></a>Partitioner</h2><div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"> def reduceByKey(func: (V, V) =&gt; V): RDD[(K, V)] = self.withScope &#123;</span><br><span class="line">    reduceByKey(defaultPartitioner(self), func)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">reduceByKey走的是 defaultPartitioner</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def defaultPartitioner(rdd: RDD[_], others: RDD[_]*): Partitioner = &#123;</span><br><span class="line">    val rdds = (Seq(rdd) ++ others)</span><br><span class="line">    val hasPartitioner = rdds.filter(_.partitioner.exists(_.numPartitions &gt; 0))</span><br><span class="line">    if (hasPartitioner.nonEmpty) &#123;</span><br><span class="line">      hasPartitioner.maxBy(_.partitions.length).partitioner.get</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      if (rdd.context.conf.contains(&quot;spark.default.parallelism&quot;)) &#123;</span><br><span class="line">        new HashPartitioner(rdd.context.defaultParallelism)</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        new HashPartitioner(rdds.map(_.partitions.length).max)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">RDD的5大特性中有一条是 Partitioner</span><br></pre></td></tr></table></figure></div>
<p><img src="https://img-blog.csdnimg.cn/20191024101322660.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9kb3VibGVoYXBweS5ibG9nLmNzZG4ubmV0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">def sortByKey(ascending: Boolean = true, numPartitions: Int = self.partitions.length)</span><br><span class="line">      : RDD[(K, V)] = self.withScope</span><br><span class="line">  &#123;</span><br><span class="line">    val part = new RangePartitioner(numPartitions, self, ascending)</span><br><span class="line">    new ShuffledRDD[K, V, V](self, part)</span><br><span class="line">      .setKeyOrdering(if (ascending) ordering else ordering.reverse)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">RangePartitioner：</span><br><span class="line"></span><br><span class="line">object PartitionerApp &#123;</span><br><span class="line"></span><br><span class="line">  def main(args: Array[String]): Unit = &#123;</span><br><span class="line">    val sc = ContextUtils.getSparkContext(this.getClass.getSimpleName)</span><br><span class="line">  </span><br><span class="line">    val data = sc.parallelize(List(1,2,3,4,5,6,30,100,300,400,500),3)</span><br><span class="line">  //Kafka分区策略</span><br><span class="line">    data.zipWithIndex().sortByKey()</span><br><span class="line">      .mapPartitionsWithIndex((index, partition)=&gt;&#123;</span><br><span class="line">        partition.map(x=&gt;s&quot;分区是$index, 元素是$&#123;x._1&#125;&quot;)</span><br><span class="line">      &#125;).printInfo()</span><br><span class="line"></span><br><span class="line">    sc.stop()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">结果是：</span><br><span class="line">分区是0, 元素是1</span><br><span class="line">分区是0, 元素是2</span><br><span class="line">分区是0, 元素是3</span><br><span class="line">分区是0, 元素是4</span><br><span class="line">分区是1, 元素是5</span><br><span class="line">分区是1, 元素是6</span><br><span class="line">分区是1, 元素是30</span><br><span class="line">分区是1, 元素是100</span><br><span class="line">分区是2, 元素是300</span><br><span class="line">分区是2, 元素是400</span><br><span class="line">分区是2, 元素是500</span><br><span class="line">-------------------------</span><br></pre></td></tr></table></figure></div>

<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">def groupByKey(): RDD[(K, Iterable[V])] = self.withScope &#123;</span><br><span class="line">    groupByKey(defaultPartitioner(self))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">defaultPartitioner --》HashPartitioner</span><br><span class="line"></span><br><span class="line">object PartitionerApp &#123;</span><br><span class="line">  def main(args: Array[String]): Unit = &#123;</span><br><span class="line">    val sc = ContextUtils.getSparkContext(this.getClass.getSimpleName)</span><br><span class="line">   </span><br><span class="line">    val data = sc.parallelize(List(1,2,3,4,5,6,30,100,300,400,500),3)</span><br><span class="line">    data.zipWithIndex().groupByKey()</span><br><span class="line">      .mapPartitionsWithIndex((index, partition)=&gt;&#123;</span><br><span class="line">        partition.map(x=&gt;s&quot;分区是$index, 元素是$&#123;x._1&#125;&quot;)</span><br><span class="line">      &#125;).printInfo()</span><br><span class="line"></span><br><span class="line">    sc.stop()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">结果是;</span><br><span class="line">分区是0, 元素是300</span><br><span class="line">分区是0, 元素是30</span><br><span class="line">分区是0, 元素是6</span><br><span class="line">分区是0, 元素是3</span><br><span class="line">分区是1, 元素是100</span><br><span class="line">分区是1, 元素是4</span><br><span class="line">分区是1, 元素是1</span><br><span class="line">分区是1, 元素是400</span><br><span class="line">分区是2, 元素是500</span><br><span class="line">分区是2, 元素是5</span><br><span class="line">分区是2, 元素是2</span><br><span class="line">-------------------------</span><br></pre></td></tr></table></figure></div>
<h2 id="多路径输出-定制化业务"><a href="#多路径输出-定制化业务" class="headerlink" title="多路径输出 ***定制化业务"></a>多路径输出 ***定制化业务</h2><div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">日志格式：</span><br><span class="line">uid1	Andriod	v3	215.197.96.120	4780	2019-09-11 08:37:33	9232	app19-20-18	香港			2019	09	11</span><br><span class="line">uid4	Symbain	71.10.97	168.170.39.193	189	2019-09-11 01:44:36	9232	app19-20-18	湖北	武汉	联通	2019	09	11</span><br><span class="line">uid2	linux	v2	168.170.39.193	189	2019-09-11 03:08:19	9232	app15-1-14-11	湖北	武汉	联通	2019	09	11</span><br><span class="line">uid3	linux	v2	168.170.39.193	189	2019-09-11 03:51:14	9232	app15-1-14-11	湖北	武汉	联通	2019	09	11</span><br><span class="line">uid6	mac	71.10.97	171.125.131.128	4780	2019-09-11 06:54:29	9232	app19-20-18	山西	忻州	联通	2019	09	11</span><br><span class="line">uid10	mac	71.10.97	171.125.131.128	4780	2019-09-11 07:09:27	189	app15-1-14-11	山西	忻州	联通	2019	09	11</span><br><span class="line"></span><br><span class="line">eg：给你一个完整的日志 做成 客户定制版  （可以去各大云平台cdn上查看产品）</span><br><span class="line">这个功能很重要 定制是收钱的（这个功能 公司一年收益是很多的 ）</span><br><span class="line"></span><br><span class="line">       1.假设按照不同的 品牌进行落盘</span><br><span class="line">       Andriod的数据都落在 Andriod的文件夹下</span><br><span class="line">       Symbain的数据都落在 Symbain的文件夹下</span><br><span class="line">      2. 输出的日志 客户想要什么字段的日志就输出什么字段的日志 （而不是把全部的日志都输出）</span><br></pre></td></tr></table></figure></div>

<p> <strong>1.假设按照不同的 品牌进行落盘</strong></p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">输出的时候相当于根据某一个字段进行输出</span><br></pre></td></tr></table></figure></div>
<p>我们一步一步的来：</p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">object MulitOutputApp &#123;</span><br><span class="line"></span><br><span class="line">  def main(args: Array[String]): Unit = &#123;</span><br><span class="line">    val sc = ContextUtils.getSparkContext(this.getClass.getSimpleName)</span><br><span class="line"></span><br><span class="line">    val output = &quot;file:///C:/IdeaProjects/spark/out/mulit&quot;</span><br><span class="line">    /**</span><br><span class="line">      * Android</span><br><span class="line">      *   xxxx.log</span><br><span class="line">      *</span><br><span class="line">      * iOS</span><br><span class="line">      *   xxx.log</span><br><span class="line">      */</span><br><span class="line">    val input = sc.textFile(&quot;file:///C:/IdeaProjects/spark/data/access.log&quot;)</span><br><span class="line">    input.map(x =&gt; &#123;</span><br><span class="line">      val splits = x.split(&quot;\t&quot;)</span><br><span class="line">      (splits(1), x) // (platform , 完整的日志)</span><br><span class="line">    &#125;).partitionBy(new HashPartitioner(8))</span><br><span class="line">      .saveAsTextFile(output)</span><br><span class="line">    sc.stop()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">这个结果肯定是不对的 都放到一个目录下的</span><br></pre></td></tr></table></figure></div>
<p><img src="https://img-blog.csdnimg.cn/2019102412035911.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9kb3VibGVoYXBweS5ibG9nLmNzZG4ubmV0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">所有日志到在一个文件夹下：</span><br><span class="line">part-00000：mac、linux、Symbain  的 数据</span><br><span class="line">part-00001：Andriod </span><br><span class="line">part-00002 ：空</span><br><span class="line">part-00003：空</span><br><span class="line">part-00004：windows</span><br><span class="line">	</span><br><span class="line">	不仅仅是日志到在一个文件夹下 而且有的同一个文件下有别的品牌的数据</span><br></pre></td></tr></table></figure></div>

<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">1.我们是要把某一个字段作为输出文件夹名 </span><br><span class="line">这就是多目录输出 </span><br><span class="line">2.mapreduce里面有这个类  MultipleTextOutputFormat</span><br><span class="line">所以我们自己实现一个类继承这个类就可以</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * This class extends the MultipleOutputFormat, allowing to write the output</span><br><span class="line"> * data to different output files in Text output format.</span><br><span class="line"> */</span><br><span class="line">@InterfaceAudience.Public</span><br><span class="line">@InterfaceStability.Stable</span><br><span class="line">public class MultipleTextOutputFormat&lt;K, V&gt;</span><br><span class="line">    extends MultipleOutputFormat&lt;K, V&gt; &#123;</span><br><span class="line"></span><br><span class="line">  private TextOutputFormat&lt;K, V&gt; theTextOutputFormat = null;</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  protected RecordWriter&lt;K, V&gt; getBaseRecordWriter(FileSystem fs, JobConf job,</span><br><span class="line">      String name, Progressable arg3) throws IOException &#123;</span><br><span class="line">    if (theTextOutputFormat == null) &#123;</span><br><span class="line">      theTextOutputFormat = new TextOutputFormat&lt;K, V&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    return theTextOutputFormat.getRecordWriter(fs, job, name, arg3);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class MyDataMultipleTextOutputFormat extends MultipleTextOutputFormat[Any,Any]&#123;</span><br><span class="line">    补充里面的实现方法</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></div>
<p><img src="https://img-blog.csdnimg.cn/20191024121310993.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9kb3VibGVoYXBweS5ibG9nLmNzZG4ubmV0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>没有自己想要的方法，继续看MultipleTextOutputFormat的父类<br><img src="https://img-blog.csdnimg.cn/20191024121544286.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9kb3VibGVoYXBweS5ibG9nLmNzZG4ubmV0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> class MyDataMultipleTextOutputFormat extends MultipleTextOutputFormat[Any,Any]&#123;</span><br><span class="line">    override def generateFileNameForKeyValue(key: Any, value: Any, name: String): String = &#123;</span><br><span class="line">      s&quot;$key/$name&quot;   </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">注意：</span><br><span class="line"> 1.</span><br><span class="line">   s&quot;$key/$name&quot;   </span><br><span class="line">   key和name是什么东西呢？一会debug看一下</span><br><span class="line">2.这个东西写好了之后怎么用呢？</span><br><span class="line"> 第一个测试代码基础上 就不能使用saveAsTextFile</span><br><span class="line"> 因为你要定向输出到某一个类里面去 需要设置FileOutputFormat</span><br><span class="line"></span><br><span class="line">这和在mapreduce里是一样的 </span><br><span class="line">这块就要使用 saveAsHadoopFile</span><br></pre></td></tr></table></figure></div>
<p><img src="https://img-blog.csdnimg.cn/20191024122713780.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9kb3VibGVoYXBweS5ibG9nLmNzZG4ubmV0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Output the RDD to any Hadoop-supported file system, using a Hadoop `OutputFormat` class</span><br><span class="line"> * supporting the key and value types K and V in this RDD. Compress with the supplied codec.</span><br><span class="line"> */</span><br><span class="line">def saveAsHadoopFile(</span><br><span class="line">    path: String,</span><br><span class="line">    keyClass: Class[_],</span><br><span class="line">    valueClass: Class[_],</span><br><span class="line">    outputFormatClass: Class[_ &lt;: OutputFormat[_, _]],</span><br><span class="line">    codec: Class[_ &lt;: CompressionCodec]): Unit = self.withScope &#123;</span><br><span class="line">  saveAsHadoopFile(path, keyClass, valueClass, outputFormatClass,</span><br><span class="line">    new JobConf(self.context.hadoopConfiguration), Some(codec))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">object MulitOutputApp &#123;</span><br><span class="line"></span><br><span class="line">  def main(args: Array[String]): Unit = &#123;</span><br><span class="line">    val sc = ContextUtils.getSparkContext(this.getClass.getSimpleName)</span><br><span class="line"></span><br><span class="line">    val output = &quot;file:///C:/IdeaProjects/spark/out/mulit&quot;</span><br><span class="line">    val input = sc.textFile(&quot;file:///C:/IdeaProjects/spark/data/access.log&quot;)</span><br><span class="line">    input.map(x =&gt; &#123;</span><br><span class="line">      val splits = x.split(&quot;\t&quot;)</span><br><span class="line">      (splits(1), x) // (platform , 完整的日志)</span><br><span class="line">    &#125;).partitionBy(new HashPartitioner(5))</span><br><span class="line">      .saveAsHadoopFile(output,classOf[String],classOf[String],classOf[RuozedataMultipleTextOutputFormat])</span><br><span class="line">    sc.stop()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  class RuozedataMultipleTextOutputFormat extends MultipleTextOutputFormat[Any,Any]&#123;</span><br><span class="line">    override def generateFileNameForKeyValue(key: Any, value: Any, name: String): String = &#123;</span><br><span class="line">      s&quot;$key/$name&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">查看结果：</span><br></pre></td></tr></table></figure></div>
<p><img src="https://img-blog.csdnimg.cn/20191024123422488.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9kb3VibGVoYXBweS5ibG9nLmNzZG4ubmV0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20191024123557180.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9kb3VibGVoYXBweS5ibG9nLmNzZG4ubmV0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>怎么才能去掉呢？<br><img src="https://img-blog.csdnimg.cn/2019102412383967.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9kb3VibGVoYXBweS5ibG9nLmNzZG4ubmV0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">知道了kv代表了什么。那么如何去掉文件里的多出那一列key值呢？</span><br></pre></td></tr></table></figure></div>
<p><img src="https://img-blog.csdnimg.cn/2019102412411829.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9kb3VibGVoYXBweS5ibG9nLmNzZG4ubmV0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">默认generateActualKey 返回是最终输出的key  所以我们自定义的类里 重写这个方法 就ok了</span><br><span class="line">  /**</span><br><span class="line">   * Generate the actual key from the given key/value. The default behavior is that</span><br><span class="line">   * the actual key is equal to the given key</span><br><span class="line">   * </span><br><span class="line">   * @param key</span><br><span class="line">   *          the key of the output data</span><br><span class="line">   * @param value</span><br><span class="line">   *          the value of the output data</span><br><span class="line">   * @return the actual key derived from the given key/value</span><br><span class="line">   */</span><br><span class="line">  protected K generateActualKey(K key, V value) &#123;</span><br><span class="line">    return key;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></div>

<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> class RuozedataMultipleTextOutputFormat extends MultipleTextOutputFormat[Any,Any]&#123;</span><br><span class="line">    override def generateFileNameForKeyValue(key: Any, value: Any, name: String): String = &#123;</span><br><span class="line">      s&quot;$key/$name&quot;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    override def generateActualKey(key: Any, value: Any): AnyRef = &#123;</span><br><span class="line">      NullWritable.get()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">你mapreduce代码里 不输出值 用什么？使用NullWritable.get()   不可能使用 “” 或者 null 你可以测试一下使用它们输出是什么。</span><br></pre></td></tr></table></figure></div>

<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">object MulitOutputApp &#123;</span><br><span class="line"></span><br><span class="line">  def main(args: Array[String]): Unit = &#123;</span><br><span class="line">    val sc = ContextUtils.getSparkContext(this.getClass.getSimpleName)</span><br><span class="line"></span><br><span class="line">    val output = &quot;file:///C:/IdeaProjects/spark/out/mulit&quot;</span><br><span class="line">    val input = sc.textFile(&quot;file:///C:/IdeaProjects/spark/data/access.log&quot;)</span><br><span class="line">    input.map(x =&gt; &#123;</span><br><span class="line">      val splits = x.split(&quot;\t&quot;)</span><br><span class="line">      (splits(1), x) // (platform , 完整的日志)</span><br><span class="line">    &#125;).partitionBy(new HashPartitioner(5))</span><br><span class="line">      .saveAsHadoopFile(output,classOf[String],classOf[String],classOf[RuozedataMultipleTextOutputFormat])</span><br><span class="line">    sc.stop()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  class RuozedataMultipleTextOutputFormat extends MultipleTextOutputFormat[Any,Any]&#123;</span><br><span class="line">    override def generateFileNameForKeyValue(key: Any, value: Any, name: String): String = &#123;</span><br><span class="line">      s&quot;$key/$name&quot;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    override def generateActualKey(key: Any, value: Any): AnyRef = &#123;</span><br><span class="line">      NullWritable.get()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">查看结果</span><br></pre></td></tr></table></figure></div>
<p><img src="https://img-blog.csdnimg.cn/20191024124752801.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9kb3VibGVoYXBweS5ibG9nLmNzZG4ubmV0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>基本功能实现完成 </p>

      
    </div>
    
      <footer class="article-footer">
        完
      </footer>
    
  </div>
  
    
<nav id="article-nav">
  <div class="article-nav-block">
    
      <a href="/2018/01/25/Spark008-%E8%A1%A5%E5%85%85Spark007/" id="article-nav-newer" class="article-nav-link-wrap">
        <strong class="article-nav-caption"></strong>
        <div class="article-nav-title">
          
            Spark008--补充Spark007
          
        </div>
      </a>
    
  </div>
  <div class="article-nav-block">
    
      <a href="/2018/01/24/Spark06-%E4%BE%9D%E8%B5%96%E5%85%B3%E7%B3%BB/" id="article-nav-older" class="article-nav-link-wrap">
        <div class="article-nav-title">Spark06--依赖关系</div>
        <strong class="article-nav-caption"></strong>
      </a>
    
  </div>
</nav>

    <link rel="stylesheet" href="/css/gitment.css"> 
<script src="/js/gitment.js"></script>

<div id="gitmentContainer"></div>

<script>
var gitment = new Gitment({
  owner: '',
  repo: '',
  oauth: {
    client_id: '',
    client_secret: '',
  },
})
gitment.render('gitmentContainer')
</script>

  
  
</article>
</section>
        <aside id="sidebar">
  
    <div class="widget-box">
  <div class="avatar-box">
    <img class="avatar" src="/images/default-avatar.jpg" title="图片来自网络"></img>
    <h3 class="avatar-name">
      
        DoubleHappy
      
    </h3>
    <p class="avatar-slogan">
      特别耐撕的大数据，资深的打酱油攻城狮。
    </p>
  </div>
</div>


  
    

  
    

  
    
  
    
  <div class="widget-box">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li></ul>
    </div>
  </div>

  
    
  <div class="widget-box">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/01/05/Azkaban%E8%B0%83%E5%BA%A6-double-happy/">Azkaban调度--double_happy</a>
          </li>
        
          <li>
            <a href="/2019/01/04/Zookeeper%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8%E4%B8%8E%E7%9B%91%E6%8E%A7-Curator/">Zookeeper基本使用与监控(Curator)</a>
          </li>
        
          <li>
            <a href="/2018/04/17/SparkSQL-TextFile%E8%BE%93%E5%87%BA%E5%A4%9A%E5%88%97/">SparkSQL--TextFile输出多列</a>
          </li>
        
          <li>
            <a href="/2018/03/17/%E9%9B%85%E6%81%A9%E8%B5%84%E6%BA%90%E8%B0%83%E4%BC%98-double-happy/">雅恩资源调优---double_happy</a>
          </li>
        
          <li>
            <a href="/2018/02/22/SS04/">SS04</a>
          </li>
        
      </ul>
    </div>
  </div>

  
      <div class="widget-box">
    <h3 class="widget-title">友链</h3>
    <div class="widget">
      
        <a style="display: block;" href="https://liverrrr.fun/archives" title target='_blank'
        >一路眼瞎</a>
      
    </div>
  </div>

  
</aside>
      </div>
      <footer id="footer">
  <div class="foot-box global-width">
    &copy; 2019 DoubleHappy &nbsp;&nbsp;
    Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    &nbsp;|&nbsp;主题 <a href="https://github.com/yiluyanxia/hexo-theme-antiquity" target="_blank" rel="noopener">antiquity</a>
    <br>
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span id="busuanzi_container_site_pv">不蒜子告之   阁下是第<span id="busuanzi_value_site_pv"></span>个访客</span>
  </div>
</footer>
      <script src="https://code.jquery.com/jquery-2.0.3.min.js"></script>
<script>
if (!window.jQuery) {
var script = document.createElement('script');
script.src = "/js/jquery-2.0.3.min.js";
document.body.write(script);
}
</script>


<script src="/js/script.js"></script>



    </div>
    <nav id="mobile-nav" class="mobile-nav-box">
  <div class="mobile-nav-img mobile-nav-top"></div>
  
    <a href="/archives" class="mobile-nav-link">首页</a>
  
    <a href="/archives" class="mobile-nav-link">归档</a>
  
  <div class="mobile-nav-img  mobile-nav-bottom"></div>
</nav>    
  </div>
</body>
</html>